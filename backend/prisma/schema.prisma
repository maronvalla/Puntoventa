generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String   @unique
  password  String
  name      String
  role      Role     @default(CASHIER)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales            Sale[]
  purchases        Purchase[]
  stockAdjustments StockAdjustment[]

  @@map("users")
}

enum Role {
  ADMIN
  CASHIER
}

model Product {
  id        String   @id @default(cuid())
  name      String
  price     Decimal  @db.Decimal(12, 2)
  costPrice Decimal  @db.Decimal(12, 2)
  barcode   String?
  code      String   @unique
  stock     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  saleItems        SaleItem[]
  purchaseItems    PurchaseItem[]
  stockAdjustments StockAdjustment[]

  @@map("products")
}

model Sale {
  id             String        @id @default(cuid())
  seller         User          @relation(fields: [sellerId], references: [id])
  sellerId       String
  sellerName     String
  dayKey         String        // YYYY-MM-DD format
  total          Decimal       @db.Decimal(12, 2)
  paymentMethod  PaymentMethod @default(CASH)
  cashAmount     Decimal       @db.Decimal(12, 2) @default(0)
  transferAmount Decimal       @db.Decimal(12, 2) @default(0)
  status         SaleStatus    @default(ACTIVE)
  voidReason     String?
  voidedAt       DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  items SaleItem[]

  @@index([dayKey])
  @@index([sellerId])
  @@index([status])
  @@map("sales")
}

enum PaymentMethod {
  CASH
  TRANSFER
  MIXED
}

enum SaleStatus {
  ACTIVE
  VOIDED
}

model SaleItem {
  id            String  @id @default(cuid())
  sale          Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  saleId        String
  product       Product @relation(fields: [productId], references: [id])
  productId     String
  name          String
  qty           Int
  unitPrice     Decimal @db.Decimal(12, 2)
  itemCostPrice Decimal @db.Decimal(12, 2)
  barcode       String?
  code          String?
  lineTotal     Decimal @db.Decimal(12, 2)

  @@map("sale_items")
}

model Purchase {
  id        String   @id @default(cuid())
  admin     User     @relation(fields: [adminId], references: [id])
  adminId   String
  adminName String
  dayKey    String   // YYYY-MM-DD format
  totalCost Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items PurchaseItem[]

  @@index([dayKey])
  @@map("purchases")
}

model PurchaseItem {
  id         String  @id @default(cuid())
  purchase   Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  purchaseId String
  product    Product  @relation(fields: [productId], references: [id])
  productId  String
  name       String
  qty        Int
  costPrice  Decimal  @db.Decimal(12, 2)

  @@map("purchase_items")
}

model StockAdjustment {
  id        String   @id @default(cuid())
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  delta     Int
  reason    String
  admin     User     @relation(fields: [adminId], references: [id])
  adminId   String
  adminName String
  createdAt DateTime @default(now())

  @@map("stock_adjustments")
}
